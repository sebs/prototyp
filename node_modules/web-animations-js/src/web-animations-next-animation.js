// Copyright 2014 Google Inc. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
//     You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//     See the License for the specific language governing permissions and
// limitations under the License.
(function(shared,scope,testing){scope.animationsWithPromises=[];scope.Animation=function(effect,timeline){this.id="";if(effect&&effect._id){this.id=effect._id}this.effect=effect;if(effect){effect._animation=this}if(!timeline){throw new Error("Animation with null timeline is not supported")}this._timeline=timeline;this._sequenceNumber=shared.sequenceNumber++;this._holdTime=0;this._paused=!1;this._isGroup=!1;this._animation=null;this._childAnimations=[];this._callback=null;this._oldPlayState="idle";this._rebuildUnderlyingAnimation();// Animations are constructed in the idle state.
this._animation.cancel();this._updatePromises()};scope.Animation.prototype={_updatePromises:function _updatePromises(){var oldPlayState=this._oldPlayState,newPlayState=this.playState;if(this._readyPromise&&newPlayState!==oldPlayState){if("idle"==newPlayState){this._rejectReadyPromise();this._readyPromise=void 0}else if("pending"==oldPlayState){this._resolveReadyPromise()}else if("pending"==newPlayState){this._readyPromise=void 0}}if(this._finishedPromise&&newPlayState!==oldPlayState){if("idle"==newPlayState){this._rejectFinishedPromise();this._finishedPromise=void 0}else if("finished"==newPlayState){this._resolveFinishedPromise()}else if("finished"==oldPlayState){this._finishedPromise=void 0}}this._oldPlayState=this.playState;return this._readyPromise||this._finishedPromise},_rebuildUnderlyingAnimation:function _rebuildUnderlyingAnimation(){this._updatePromises();var oldPlaybackRate,oldPaused,oldStartTime,oldCurrentTime,hadUnderlying=this._animation?!0:!1;if(hadUnderlying){oldPlaybackRate=this.playbackRate;oldPaused=this._paused;oldStartTime=this.startTime;oldCurrentTime=this.currentTime;this._animation.cancel();this._animation._wrapper=null;this._animation=null}if(!this.effect||babelHelpers.instanceof(this.effect,window.KeyframeEffect)){this._animation=scope.newUnderlyingAnimationForKeyframeEffect(this.effect);scope.bindAnimationForKeyframeEffect(this)}if(babelHelpers.instanceof(this.effect,window.SequenceEffect)||babelHelpers.instanceof(this.effect,window.GroupEffect)){this._animation=scope.newUnderlyingAnimationForGroup(this.effect);scope.bindAnimationForGroup(this)}if(this.effect&&this.effect._onsample){scope.bindAnimationForCustomEffect(this)}if(hadUnderlying){if(1!=oldPlaybackRate){this.playbackRate=oldPlaybackRate}if(null!==oldStartTime){this.startTime=oldStartTime}else if(null!==oldCurrentTime){this.currentTime=oldCurrentTime}else if(null!==this._holdTime){this.currentTime=this._holdTime}if(oldPaused){this.pause()}}this._updatePromises()},_updateChildren:function _updateChildren(){if(!this.effect||"idle"==this.playState)return;var offset=this.effect._timing.delay;this._childAnimations.forEach(function(childAnimation){this._arrangeChildren(childAnimation,offset);if(babelHelpers.instanceof(this.effect,window.SequenceEffect))offset+=scope.groupChildDuration(childAnimation.effect)}.bind(this))},_setExternalAnimation:function _setExternalAnimation(animation){if(!this.effect||!this._isGroup)return;for(var i=0;i<this.effect.children.length;i++){this.effect.children[i]._animation=animation;this._childAnimations[i]._setExternalAnimation(animation)}},_constructChildAnimations:function _constructChildAnimations(){if(!this.effect||!this._isGroup)return;var offset=this.effect._timing.delay;this._removeChildAnimations();this.effect.children.forEach(function(child){var childAnimation=scope.timeline._play(child);this._childAnimations.push(childAnimation);childAnimation.playbackRate=this.playbackRate;if(this._paused)childAnimation.pause();child._animation=this.effect._animation;this._arrangeChildren(childAnimation,offset);if(babelHelpers.instanceof(this.effect,window.SequenceEffect))offset+=scope.groupChildDuration(child)}.bind(this))},_arrangeChildren:function _arrangeChildren(childAnimation,offset){if(null===this.startTime){childAnimation.currentTime=this.currentTime-offset/this.playbackRate}else if(childAnimation.startTime!==this.startTime+offset/this.playbackRate){childAnimation.startTime=this.startTime+offset/this.playbackRate}},get timeline(){return this._timeline},get playState(){return this._animation?this._animation.playState:"idle"},get finished(){if(!window.Promise){console.warn("Animation Promises require JavaScript Promise constructor");return null}if(!this._finishedPromise){if(-1==scope.animationsWithPromises.indexOf(this)){scope.animationsWithPromises.push(this)}this._finishedPromise=new Promise(function(resolve,reject){this._resolveFinishedPromise=function(){resolve(this)};this._rejectFinishedPromise=function(){reject({type:DOMException.ABORT_ERR,name:"AbortError"})}}.bind(this));if("finished"==this.playState){this._resolveFinishedPromise()}}return this._finishedPromise},get ready(){if(!window.Promise){console.warn("Animation Promises require JavaScript Promise constructor");return null}if(!this._readyPromise){if(-1==scope.animationsWithPromises.indexOf(this)){scope.animationsWithPromises.push(this)}this._readyPromise=new Promise(function(resolve,reject){this._resolveReadyPromise=function(){resolve(this)};this._rejectReadyPromise=function(){reject({type:DOMException.ABORT_ERR,name:"AbortError"})}}.bind(this));if("pending"!==this.playState){this._resolveReadyPromise()}}return this._readyPromise},get onfinish(){return this._animation.onfinish},set onfinish(v){if("function"==typeof v){this._animation.onfinish=function(e){e.target=this;v.call(this,e)}.bind(this)}else{this._animation.onfinish=v}},get oncancel(){return this._animation.oncancel},set oncancel(v){if("function"==typeof v){this._animation.oncancel=function(e){e.target=this;v.call(this,e)}.bind(this)}else{this._animation.oncancel=v}},get currentTime(){this._updatePromises();var currentTime=this._animation.currentTime;this._updatePromises();return currentTime},set currentTime(v){this._updatePromises();this._animation.currentTime=isFinite(v)?v:Math.sign(v)*Number.MAX_VALUE;this._register();this._forEachChild(function(child,offset){child.currentTime=v-offset});this._updatePromises()},get startTime(){return this._animation.startTime},set startTime(v){this._updatePromises();this._animation.startTime=isFinite(v)?v:Math.sign(v)*Number.MAX_VALUE;this._register();this._forEachChild(function(child,offset){child.startTime=v+offset});this._updatePromises()},get playbackRate(){return this._animation.playbackRate},set playbackRate(value){this._updatePromises();var oldCurrentTime=this.currentTime;this._animation.playbackRate=value;this._forEachChild(function(childAnimation){childAnimation.playbackRate=value});if(null!==oldCurrentTime){this.currentTime=oldCurrentTime}this._updatePromises()},play:function play(){this._updatePromises();this._paused=!1;this._animation.play();if(-1==this._timeline._animations.indexOf(this)){this._timeline._animations.push(this)}this._register();scope.awaitStartTime(this);this._forEachChild(function(child){var time=child.currentTime;child.play();child.currentTime=time});this._updatePromises()},pause:function pause(){this._updatePromises();if(this.currentTime){this._holdTime=this.currentTime}this._animation.pause();this._register();this._forEachChild(function(child){child.pause()});this._paused=!0;this._updatePromises()},finish:function finish(){this._updatePromises();this._animation.finish();this._register();this._updatePromises()},cancel:function cancel(){this._updatePromises();this._animation.cancel();this._register();this._removeChildAnimations();this._updatePromises()},reverse:function reverse(){this._updatePromises();var oldCurrentTime=this.currentTime;this._animation.reverse();this._forEachChild(function(childAnimation){childAnimation.reverse()});if(null!==oldCurrentTime){this.currentTime=oldCurrentTime}this._updatePromises()},addEventListener:function addEventListener(type,handler){var wrapped=handler;if("function"==typeof handler){wrapped=function(e){e.target=this;handler.call(this,e)}.bind(this);handler._wrapper=wrapped}this._animation.addEventListener(type,wrapped)},removeEventListener:function removeEventListener(type,handler){this._animation.removeEventListener(type,handler&&handler._wrapper||handler)},_removeChildAnimations:function _removeChildAnimations(){while(this._childAnimations.length){this._childAnimations.pop().cancel()}},_forEachChild:function _forEachChild(f){var offset=0;if(this.effect.children&&this._childAnimations.length<this.effect.children.length)this._constructChildAnimations();this._childAnimations.forEach(function(child){f.call(this,child,offset);if(babelHelpers.instanceof(this.effect,window.SequenceEffect))offset+=child.effect.activeDuration}.bind(this));if("pending"==this.playState)return;var timing=this.effect._timing,t=this.currentTime;if(null!==t)t=shared.calculateIterationProgress(shared.calculateActiveDuration(timing),t,timing);if(null==t||isNaN(t))this._removeChildAnimations()}};window.Animation=scope.Animation;if(WEB_ANIMATIONS_TESTING){testing.webAnimationsNextAnimation=scope.Animation}})(webAnimationsShared,webAnimationsNext,webAnimationsTesting);